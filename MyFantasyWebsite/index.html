<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Fantasy Football Draft Dashboard with AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .nav-btn {
            transition: all 0.3s ease;
        }
        .nav-btn.active {
            background-color: #f59e0b;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #f59e0b;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tier-1 { background-color: #fef3c7; }
        .tier-2 { background-color: #e0f2fe; }
        .tier-3 { background-color: #f0fdf4; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">2025 Fantasy Football AI Dashboard</h1>
            <p class="text-slate-600 mt-2 text-lg">Your interactive guide to dominating your Superflex & IDP league.</p>
        </header>

        <nav class="flex justify-center mb-8 bg-slate-200 rounded-lg p-2 shadow-inner">
            <button data-view="dashboard" class="nav-btn active text-slate-700 font-semibold py-2 px-4 rounded-md">Dashboard</button>
            <button data-view="rankings" class="nav-btn text-slate-700 font-semibold py-2 px-4 rounded-md">Player Rankings</button>
            <button data-view="strategy" class="nav-btn text-slate-700 font-semibold py-2 px-4 rounded-md">Draft Strategies</button>
            <button data-view="idp" class="nav-btn text-slate-700 font-semibold py-2 px-4 rounded-md">IDP Guide</button>
        </nav>

        <main id="main-content">
            <div class="flex justify-center items-center h-64">
                <div class="spinner"></div>
                <p class="ml-4 text-slate-600">Loading player data...</p>
            </div>
        </main>
    </div>

    <!-- Modal for AI Player Analysis -->
    <div id="ai-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-900">AI Analysis</h2>
                <button id="modal-close-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body">
                <!-- AI content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        const App = {
            state: {
                currentView: 'dashboard',
                players: [],
                filteredPlayers: [],
                charts: {},
                positionRanks: {},
                dataLoaded: false
            },
            
            async init() {
                await this.fetchData();
                this.render();
                this.addEventListeners();
            },

            async fetchData() {
                try {
                    // Try to fetch from Netlify function first
                    let response;
                    try {
                        response = await fetch('/.netlify/functions/sleeper');
                        if (response.ok) {
                            const data = await response.json();
                            console.log("Successfully fetched from Sleeper API:", data.length, "players");
                            this.processPlayerData(data);
                            this.state.dataLoaded = true;
                            return;
                        }
                    } catch (error) {
                        console.warn("Netlify function unavailable:", error);
                    }
                    
                    // Fallback to mock data if API fails
                    console.log("Using mock data for demonstration");
                    const mockData = this.generateMockData();
                    this.processPlayerData(mockData);
                    this.state.dataLoaded = true;
                    
                } catch (error) {
                    console.error("Error in fetchData:", error);
                    const mockData = this.generateMockData();
                    this.processPlayerData(mockData);
                    this.state.dataLoaded = true;
                }
            },

            processPlayerData(rawData) {
                // Process and clean the data
                this.state.players = rawData
                    .filter(p => p.position && ['QB', 'RB', 'WR', 'TE', 'DL', 'LB', 'DB'].includes(p.position))
                    .map(p => ({
                        id: p.player_id || Math.random().toString(),
                        name: p.full_name || `${p.first_name || ''} ${p.last_name || ''}`.trim() || 'Unknown Player',
                        pos: p.position,
                        team: p.team || 'FA',
                        adp: p.adp || Math.floor(Math.random() * 200) + 50,
                        adp_ppr: p.adp_ppr || p.adp || Math.floor(Math.random() * 200) + 50
                    }))
                    .sort((a, b) => (a.adp || 999) - (b.adp || 999));

                // Calculate position ranks and overall ranks
                this.calculateRanks();
                this.state.filteredPlayers = [...this.state.players];
                console.log("Processed players:", this.state.players.length);
            },

            generateMockData() {
                // Create comprehensive mock data
                const mockPlayers = [
                    // Top QBs
                    { player_id: '1', full_name: 'Josh Allen', position: 'QB', team: 'BUF', adp: 15 },
                    { player_id: '2', full_name: 'Lamar Jackson', position: 'QB', team: 'BAL', adp: 18 },
                    { player_id: '3', full_name: 'Patrick Mahomes', position: 'QB', team: 'KC', adp: 25 },
                    { player_id: '4', full_name: 'Joe Burrow', position: 'QB', team: 'CIN', adp: 35 },
                    { player_id: '5', full_name: 'Jalen Hurts', position: 'QB', team: 'PHI', adp: 40 },
                    
                    // Top RBs
                    { player_id: '10', full_name: 'Christian McCaffrey', position: 'RB', team: 'SF', adp: 1 },
                    { player_id: '11', full_name: 'Bijan Robinson', position: 'RB', team: 'ATL', adp: 3 },
                    { player_id: '12', full_name: 'Jahmyr Gibbs', position: 'RB', team: 'DET', adp: 5 },
                    { player_id: '13', full_name: 'Saquon Barkley', position: 'RB', team: 'PHI', adp: 7 },
                    { player_id: '14', full_name: 'Derrick Henry', position: 'RB', team: 'BAL', adp: 12 },
                    { player_id: '15', full_name: 'Jonathan Taylor', position: 'RB', team: 'IND', adp: 20 },
                    { player_id: '16', full_name: 'Josh Jacobs', position: 'RB', team: 'GB', adp: 28 },
                    { player_id: '17', full_name: 'Kenneth Walker III', position: 'RB', team: 'SEA', adp: 32 },
                    
                    // Top WRs
                    { player_id: '20', full_name: 'CeeDee Lamb', position: 'WR', team: 'DAL', adp: 2 },
                    { player_id: '21', full_name: 'Tyreek Hill', position: 'WR', team: 'MIA', adp: 4 },
                    { player_id: '22', full_name: 'Amon-Ra St. Brown', position: 'WR', team: 'DET', adp: 6 },
                    { player_id: '23', full_name: 'A.J. Brown', position: 'WR', team: 'PHI', adp: 8 },
                    { player_id: '24', full_name: 'Stefon Diggs', position: 'WR', team: 'HOU', adp: 10 },
                    { player_id: '25', full_name: 'DK Metcalf', position: 'WR', team: 'SEA', adp: 22 },
                    { player_id: '26', full_name: 'DeVonta Smith', position: 'WR', team: 'PHI', adp: 24 },
                    { player_id: '27', full_name: 'Jaylen Waddle', position: 'WR', team: 'MIA', adp: 26 },
                    { player_id: '28', full_name: 'Calvin Ridley', position: 'WR', team: 'TEN', adp: 30 },
                    
                    // Top TEs
                    { player_id: '30', full_name: 'Travis Kelce', position: 'TE', team: 'KC', adp: 9 },
                    { player_id: '31', full_name: 'Sam LaPorta', position: 'TE', team: 'DET', adp: 11 },
                    { player_id: '32', full_name: 'Mark Andrews', position: 'TE', team: 'BAL', adp: 19 },
                    { player_id: '33', full_name: 'T.J. Hockenson', position: 'TE', team: 'MIN', adp: 45 },
                    { player_id: '34', full_name: 'George Kittle', position: 'TE', team: 'SF', adp: 50 },
                    
                    // IDP Players
                    { player_id: '40', full_name: 'Myles Garrett', position: 'DL', team: 'CLE', adp: 180 },
                    { player_id: '41', full_name: 'T.J. Watt', position: 'LB', team: 'PIT', adp: 160 },
                    { player_id: '42', full_name: 'Aaron Donald', position: 'DL', team: 'LAR', adp: 185 },
                    { player_id: '43', full_name: 'Nick Bosa', position: 'DL', team: 'SF', adp: 190 },
                    { player_id: '44', full_name: 'Fred Warner', position: 'LB', team: 'SF', adp: 165 },
                    { player_id: '45', full_name: 'Micah Parsons', position: 'LB', team: 'DAL', adp: 155 },
                    { player_id: '46', full_name: 'Minkah Fitzpatrick', position: 'DB', team: 'PIT', adp: 200 },
                    { player_id: '47', full_name: 'Derwin James Jr.', position: 'DB', team: 'LAC', adp: 205 },
                    { player_id: '48', full_name: 'Kyle Hamilton', position: 'DB', team: 'BAL', adp: 210 },
                ];

                // Add more players to reach ~100 total
                const additionalPlayers = [];
                const positions = ['QB', 'RB', 'WR', 'TE', 'DL', 'LB', 'DB'];
                const teams = ['BUF', 'KC', 'SF', 'DAL', 'MIA', 'DET', 'BAL', 'CLE', 'PIT', 'LAC', 'ATL', 'PHI', 'LAR', 'TB', 'GB', 'MIN'];
                const firstNames = ['Marcus', 'Brandon', 'Tyler', 'Jordan', 'Cameron', 'Austin', 'Ryan', 'Derek', 'Alex', 'Justin', 'Daniel', 'Michael', 'David', 'Chris', 'Matt', 'Jake'];
                const lastNames = ['Johnson', 'Williams', 'Brown', 'Davis', 'Miller', 'Wilson', 'Moore', 'Taylor', 'Anderson', 'Thomas', 'Jackson', 'White', 'Harris', 'Martin', 'Thompson', 'Garcia'];

                for (let i = 0; i < 60; i++) {
                    const pos = positions[Math.floor(Math.random() * positions.length)];
                    let baseAdp = 60;
                    if (pos === 'QB') baseAdp = 70;
                    else if (pos === 'RB') baseAdp = 50;
                    else if (pos === 'WR') baseAdp = 45;
                    else if (pos === 'TE') baseAdp = 80;
                    else baseAdp = 150; // IDP
                    
                    additionalPlayers.push({
                        player_id: (100 + i).toString(),
                        full_name: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                        position: pos,
                        team: teams[Math.floor(Math.random() * teams.length)],
                        adp: baseAdp + Math.floor(Math.random() * 100)
                    });
                }

                return [...mockPlayers, ...additionalPlayers];
            },

            calculateRanks() {
                // Calculate overall ranks
                this.state.players.forEach((player, index) => {
                    player.ovr = index + 1;
                    player.pprRk = index + 1;
                });

                // Calculate position-specific ranks and assign tiers
                const positions = ['QB', 'RB', 'WR', 'TE', 'DL', 'LB', 'DB'];
                positions.forEach(pos => {
                    const posPlayers = this.state.players.filter(p => p.pos === pos);
                    posPlayers.forEach((player, index) => {
                        player.posRank = index + 1;
                        // Assign tiers based on position rank
                        if (index < 3) player.tier = 1;
                        else if (index < 8) player.tier = 2;
                        else player.tier = 3;
                    });
                    this.state.positionRanks[pos] = posPlayers;
                });
            },

            addEventListeners() {
                const nav = document.querySelector('nav');
                nav.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        this.state.currentView = e.target.dataset.view;
                        this.render();
                    }
                });

                const modal = document.getElementById('ai-modal');
                const closeBtn = document.getElementById('modal-close-btn');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
                closeBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
            },
            
            render() {
                if (!this.state.dataLoaded) {
                    return;
                }

                const mainContent = document.getElementById('main-content');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === this.state.currentView);
                });

                let viewHtml = '';
                switch (this.state.currentView) {
                    case 'dashboard':
                        viewHtml = this.getDashboardView();
                        break;
                    case 'rankings':
                        viewHtml = this.getRankingsView();
                        break;
                    case 'strategy':
                        viewHtml = this.getStrategyView();
                        break;
                    case 'idp':
                        viewHtml = this.getIdpView();
                        break;
                }
                mainContent.innerHTML = `<div class="fade-in">${viewHtml}</div>`;
                this.renderCharts();
                
                if (this.state.currentView === 'rankings') {
                    this.addRankingsEventListeners();
                }
                if (this.state.currentView === 'dashboard') {
                    this.addDashboardEventListeners();
                }
                if (this.state.currentView === 'strategy') {
                    this.addStrategyEventListeners();
                }
            },

            getDashboardView() {
                // Get top value picks from actual data
                const topOffensivePlayers = this.state.players
                    .filter(p => ['QB', 'RB', 'WR', 'TE'].includes(p.pos))
                    .slice(0, 5);

                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900">Draft Strategy Comparison</h2>
                            <p class="text-slate-600 mb-4">This chart provides a high-level comparison of foundational draft strategies. Each approach carries different risks and rewards, influencing how you should allocate your early-round picks. Hover over the bars for a brief explanation of each strategy's core philosophy.</p>
                            <div class="chart-container">
                                <canvas id="strategyChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900">Top Early Picks</h2>
                            <p class="text-slate-600 mb-4">Based on current ADP, these are the elite players to target in your early rounds.</p>
                            <ul class="space-y-3">
                                ${topOffensivePlayers.map(p => `
                                    <li class="flex justify-between items-center bg-slate-100 p-3 rounded-md">
                                        <div>
                                            <p class="font-semibold">${p.name}</p>
                                            <p class="text-sm text-slate-600">${p.pos} - ${p.team}</p>
                                        </div>
                                        <span class="text-sm font-bold text-amber-600">ADP ${p.adp}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900">✨ AI Team Name Generator</h2>
                            <p class="text-slate-600 mb-4">Need some inspiration for a team name? Enter a few keywords (like your favorite player, team, or an inside joke) and let our AI generate some creative options for you!</p>
                            <div class="flex gap-2">
                                <input type="text" id="name-generator-input" placeholder="e.g., 'Bijan, mustard, champion'" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 flex-grow">
                                <button id="name-generator-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-md hover:bg-amber-600 transition-colors">Generate Names</button>
                            </div>
                            <div id="name-generator-results" class="mt-4 p-4 bg-slate-50 rounded-md min-h-[100px]">
                                <p class="text-slate-500">Your AI-generated team names will appear here.</p>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
                             <h2 class="text-2xl font-bold mb-4 text-slate-900">Foundational Principles</h2>
                             <p class="text-slate-600 mb-4">Success starts with understanding the core concepts of your league. Your specific rules for scoring, rosters (Superflex, IDP), and league size are the most critical factors in determining player value. This dashboard is tailored to a 10-team, Superflex, IDP format, which places a massive premium on quarterbacks and requires a balanced approach to drafting both offense and defense.</p>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-amber-800">Superflex is King</h3>
                                    <p class="text-sm text-amber-700">In this format, QBs are the most valuable assets. Securing two reliable starters is paramount.</p>
                                </div>
                                <div class="bg-sky-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-sky-800">Positional Scarcity</h3>
                                    <p class="text-sm text-sky-700">Understand the drop-off in talent at each position. Elite RBs and TEs are rare commodities.</p>
                                </div>
                                 <div class="bg-emerald-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-emerald-800">Tiers Over Ranks</h3>
                                    <p class="text-sm text-emerald-700">Draft from the best available tier, not just the next player on a list. Avoid reaching.</p>
                                </div>
                             </div>
                        </div>
                    </div>
                `;
            },
            
            getRankingsView() {
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900">Player Rankings (${this.state.players.length} Players Loaded)</h2>
                        <p class="text-slate-600 mb-6">Complete player rankings with proper ADP-based sorting. Use the filters to narrow down the rankings. Click the ✨ "Analyze" button for an AI-powered breakdown of any player's upcoming season.</p>
                        <div class="flex flex-wrap gap-4 mb-4">
                            <input type="text" id="searchInput" placeholder="Search player name..." class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 flex-grow">
                            <select id="posFilter" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                <option value="ALL">All Positions</option>
                                <option value="QB">QB</option>
                                <option value="RB">RB</option>
                                <option value="WR">WR</option>
                                <option value="TE">TE</option>
                                <option value="DL">DL</option>
                                <option value="LB">LB</option>
                                <option value="DB">DB</option>
                            </select>
                            <select id="scoringFilter" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                <option value="ovr">Overall Rank</option>
                                <option value="pprRk">PPR Rank</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left" id="rankingsTable">
                                <!-- Table content will be generated by JS -->
                            </table>
                        </div>
                    </div>
                `;
            },

            addDashboardEventListeners() {
                const btn = document.getElementById('name-generator-btn');
                if (btn) {
                    btn.addEventListener('click', () => this.generateTeamNames());
                }
            },

            addRankingsEventListeners() {
                document.getElementById('searchInput').addEventListener('input', () => this.filterAndRenderTable());
                document.getElementById('posFilter').addEventListener('change', () => this.filterAndRenderTable());
                document.getElementById('scoringFilter').addEventListener('change', () => this.filterAndRenderTable());
                this.renderTable();
            },

            addStrategyEventListeners() {
                const btn = document.getElementById('get-round-advice-btn');
                if (btn) {
                    btn.addEventListener('click', () => this.getRoundByRoundAdvice());
                }
            },

            filterAndRenderTable() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const posFilter = document.getElementById('posFilter').value;
                
                this.state.filteredPlayers = this.state.players.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(searchTerm);
                    const posMatch = posFilter === 'ALL' || p.pos === posFilter;
                    return nameMatch && posMatch;
                });

                this.renderTable();
            },

            renderTable() {
                const table = document.getElementById('rankingsTable');
                if (!table) return;
                
                let sortedPlayers = [...this.state.filteredPlayers];
                
                table.innerHTML = `
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="p-3 font-semibold">Overall</th>
                            <th class="p-3 font-semibold">Pos Rank</th>
                            <th class="p-3 font-semibold">Player</th>
                            <th class="p-3 font-semibold">Position</th>
                            <th class="p-3 font-semibold">Team</th>
                            <th class="p-3 font-semibold">ADP</th>
                            <th class="p-3 font-semibold text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedPlayers.map(p => `
                            <tr class="border-b border-slate-200 hover:bg-slate-50 tier-${p.tier}">
                                <td class="p-3 font-bold text-amber-600">${p.ovr}</td>
                                <td class="p-3 font-semibold">${p.pos}${p.posRank}</td>
                                <td class="p-3 font-semibold">${p.name}</td>
                                <td class="p-3">${p.pos}</td>
                                <td class="p-3">${p.team}</td>
                                <td class="p-3">${p.adp}</td>
                                <td class="p-3 text-center">
                                    <button data-player-id="${p.id}" class="analyze-btn bg-slate-200 text-slate-700 text-sm font-semibold py-1 px-3 rounded-full hover:bg-amber-200 transition-colors">✨ Analyze</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;

                document.querySelectorAll('.analyze-btn').forEach(btn => {
                    btn.
