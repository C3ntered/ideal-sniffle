<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Fantasy Football Draft Dashboard with AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #475569;
            --border-color: #cbd5e1;
            --amber-500: #f59e0b;
            --amber-100: #fef3c7;
        }

        .dark {
            --bg-primary: #1e293b;
            --bg-secondary: #334155;
            --bg-tertiary: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-tertiary: #cbd5e1;
            --border-color: #64748b;
            --amber-100: #78350f;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .nav-btn {
            transition: all 0.3s ease;
        }
        .nav-btn.active {
            background-color: #f59e0b; /* amber-500 */
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .bg-white { background-color: var(--bg-secondary) !important; }
        .bg-slate-50 { background-color: var(--bg-primary) !important; }
        .bg-slate-100 { background-color: var(--bg-tertiary) !important; }
        .bg-slate-200 { background-color: var(--bg-tertiary) !important; }
        .text-slate-900 { color: var(--text-primary) !important; }
        .text-slate-800 { color: var(--text-primary) !important; }
        .text-slate-700 { color: var(--text-tertiary) !important; }
        .text-slate-600 { color: var(--text-secondary) !important; }
        .text-slate-500 { color: var(--text-secondary) !important; }
        .border-slate-300 { border-color: var(--border-color) !important; }
        .border-slate-200 { border-color: var(--border-color) !important; }
        
        /* Dark mode specific improvements */
        .dark .bg-green-50 { background-color: #065f46; }
        .dark .bg-green-100 { background-color: #047857; }
        .dark .bg-amber-50 { background-color: #78350f; }
        .dark .bg-amber-100 { background-color: #92400e; }
        .dark .text-amber-600 { color: #fbbf24; }
        .dark .text-amber-700 { color: #f59e0b; }
        .dark .text-amber-800 { color: #d97706; }
        .dark .text-green-100 { color: #bbf7d0; }
        .dark .drafted { color: #64748b; }
        
        /* Dark mode form improvements */
        .dark input[type="text"],
        .dark input[type="number"],
        .dark select {
            background-color: #475569 !important;
            color: #f8fafc !important;
            border-color: #64748b !important;
        }
        .dark input[type="text"]::placeholder,
        .dark input[type="number"]::placeholder {
            color: #94a3b8 !important;
        }
        .dark input[type="text"]:focus,
        .dark input[type="number"]:focus,
        .dark select:focus {
            background-color: #475569 !important;
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
        }
        .dark label {
            color: #e2e8f0 !important;
        }
        
        /* Settings specific */
        .dark .preset-btn {
            background-color: #475569 !important;
            color: #e2e8f0 !important;
            border-color: #64748b !important;
        }
        .dark .preset-btn:hover {
            background-color: #64748b !important;
        }
        .dark .preset-btn.bg-amber-100 {
            background-color: #92400e !important;
            color: #fef3c7 !important;
            border-color: #d97706 !important;
        }
        
        /* Fix reset button in dark mode */
        .dark .bg-slate-300 {
            background-color: #64748b !important;
            color: #f8fafc !important;
        }
        .dark .text-slate-700 {
            color: #f8fafc !important;
        }
        .dark button:hover.bg-slate-300 {
            background-color: #475569 !important;
        }
        
        /* Fix table hover in dark mode */
        .dark tr:hover {
            background-color: #475569 !important;
        }
        .dark tr.hover\:bg-slate-50:hover {
            background-color: #475569 !important;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #f59e0b;
            animation: spin 1s ease infinite;
        }
        .dark .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #f59e0b;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .drafted {
            text-decoration: line-through;
            color: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-6 md:mb-8">
            <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-slate-900 leading-tight">2025 Fantasy Football AI Dashboard</h1>
            <p class="text-slate-600 mt-2 text-sm md:text-lg px-4">Your interactive guide to dominating your Superflex & IDP league.</p>
        </header>

        <nav class="flex flex-wrap justify-center mb-8 bg-slate-200 rounded-lg p-2 shadow-inner gap-1">
            <button data-view="dashboard" class="nav-btn active text-slate-700 font-semibold py-2 px-2 md:px-4 rounded-md text-sm md:text-base">Dashboard</button>
            <button data-view="rankings" class="nav-btn text-slate-700 font-semibold py-2 px-2 md:px-4 rounded-md text-sm md:text-base">Rankings</button>
            <button data-view="strategy" class="nav-btn text-slate-700 font-semibold py-2 px-2 md:px-4 rounded-md text-sm md:text-base">Strategy</button>
            <button data-view="idp" class="nav-btn text-slate-700 font-semibold py-2 px-2 md:px-4 rounded-md text-sm md:text-base">Defense</button>
            <button data-view="settings" class="nav-btn text-slate-700 font-semibold py-2 px-2 md:px-4 rounded-md text-sm md:text-base">Settings</button>
        </nav>

        <main id="main-content">
            <div class="flex justify-center items-center h-64">
                <div class="spinner"></div>
                <p class="ml-4 text-slate-600">Loading player data...</p>
            </div>
        </main>
    </div>

    <div id="ai-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-900">AI Analysis</h2>
                <button id="modal-close-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body">
                </div>
        </div>
    </div>



    <script>
        const App = {
            state: {
                currentView: 'dashboard',
                players: [],
                filteredPlayers: [],
                charts: {},
                draftedPlayers: new Set(),
                archivedPlayers: [],
                myTeam: [],
                myPickCount: 0,
                displayedPlayerCount: 100,
                leagueSettings: {
                    QB: 1, RB: 1, WR: 2, TE: 1, K: 0, DST: 0, FLEX: 4, SF: 1, DL: 1, LB: 1, DB: 1, BENCH: 7
                },
                darkMode: false
            },

            presets: {
                'standard': { QB: 2, RB: 4, WR: 4, TE: 2, K: 1, DST: 1, FLEX: 1, SF: 0, DL: 0, LB: 0, DB: 0 },
                'superflex': { QB: 3, RB: 4, WR: 4, TE: 2, K: 1, DST: 1, FLEX: 1, SF: 1, DL: 0, LB: 0, DB: 0 },
                'superflex-idp': { QB: 1, RB: 1, WR: 2, TE: 1, K: 0, DST: 0, FLEX: 4, SF: 1, DL: 1, LB: 1, DB: 1, BENCH: 7 },
                'deep-idp': { QB: 2, RB: 4, WR: 5, TE: 2, K: 0, DST: 0, FLEX: 0, SF: 0, DL: 2, LB: 4, DB: 3 }
            },
            
            async init() {
                this.loadSavedSettings();
                this.initDarkMode();
                await this.fetchData();
                this.render();
                this.addEventListeners();
            },

            async fetchData() {
                const mainContent = document.getElementById('main-content');
                try {
                    // Fetch the local CSV file
                    const response = await fetch('./player_data.csv');
                    if (!response.ok) {
                        throw new Error(`Could not load player_data.csv. Status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    
                    // Parse the CSV text
                    const rows = csvText.trim().split('\n');
                    const headers = rows.shift().split(',');
                    const playerData = rows.map(row => {
                        const values = row.split(',');
                        let obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = values[index];
                        });
                        return obj;
                    });

                    this.state.players = playerData
                        .map(p => {
                            // Determine if player is offensive or defensive
                            const offensivePositions = ['QB', 'RB', 'WR', 'TE', 'K'];
                            const isOffensive = offensivePositions.includes(p.pos);
                            
                            return {
                                id: p.id,
                                ovr: parseInt(p.ovr, 10),
                                name: p.name,
                                pos: p.pos,
                                team: p.team,
                                isAvailable: true,
                                bye_week: p.bye_week,
                                off_rank: p.off_rank ? parseInt(p.off_rank, 10) : null,
                                def_rank: p.def_rank ? parseInt(p.def_rank, 10) : null,
                                display_rank: isOffensive ? parseInt(p.off_rank || p.ovr, 10) : parseInt(p.def_rank || p.ovr, 10)
                            };
                        })
                        .sort((a, b) => a.display_rank - b.display_rank);

                    // Initially show only offensive players in rankings
                    const offensivePositions = ['QB', 'RB', 'WR', 'TE', 'K'];
                    this.state.filteredPlayers = this.state.players.filter(p => offensivePositions.includes(p.pos));

                } catch (error) {
                    console.error("Error loading player data:", error);
                    mainContent.innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg">
                        <h2 class="font-bold text-xl">Failed to Load Player Data</h2>
                        <p>Make sure the 'player_data.csv' file is in the same directory as this HTML file.</p>
                    </div>`;
                }
            },

            addEventListeners() {
                const nav = document.querySelector('nav');
                nav.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        this.state.currentView = e.target.dataset.view;
                        this.render();
                    }
                });

                const modal = document.getElementById('ai-modal');
                const closeBtn = document.getElementById('modal-close-btn');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
                closeBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });


                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case '1':
                                e.preventDefault();
                                this.state.currentView = 'dashboard';
                                this.render();
                                break;
                            case '2':
                                e.preventDefault();
                                this.state.currentView = 'rankings';
                                this.render();
                                break;
                            case 'Escape':
                                e.preventDefault();
                                modal.classList.add('hidden');
                                break;
                        }
                    }
                });
            },
            
            render() {
                const mainContent = document.getElementById('main-content');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === this.state.currentView);
                });

                let viewHtml = '';
                switch (this.state.currentView) {
                    case 'dashboard':
                        viewHtml = this.getDashboardView();
                        break;
                    case 'rankings':
                        viewHtml = this.getRankingsView();
                        break;
                    case 'strategy':
                        viewHtml = this.getStrategyView();
                        break;
                    case 'idp':
                        viewHtml = this.getIdpView();
                        break;
                    case 'settings':
                        viewHtml = this.getSettingsView();
                        break;
                }
                mainContent.innerHTML = `<div class="fade-in">${viewHtml}</div>`;
                this.renderCharts();
                
                if (this.state.currentView === 'rankings') {
                    this.addRankingsEventListeners();
                }
                if (this.state.currentView === 'dashboard') {
                    this.addDashboardEventListeners();
                }
                if (this.state.currentView === 'strategy') {
                    this.addStrategyEventListeners();
                }
                if (this.state.currentView === 'idp') {
                    this.addDefenseEventListeners();
                }
                if (this.state.currentView === 'settings') {
                    this.loadSettingsToForm();
                    this.addSettingsEventListeners();
                }
            },

            // --- DRAFT TRACKING LOGIC ---
            getTotalPicks() {
                return Object.values(this.state.leagueSettings).reduce((sum, count) => sum + count, 0);
            },

            handleDraft(playerId, isMyPick = false) {
                const player = this.state.players.find(p => p.id == playerId);
                if (player && player.isAvailable) {
                    player.isAvailable = false;
                    this.state.draftedPlayers.add(playerId);
                    
                    // Add to archived players with draft info
                    const archivedPlayer = {...player, draftedByUser: isMyPick, draftOrder: this.state.archivedPlayers.length + 1};
                    this.state.archivedPlayers.push(archivedPlayer);
                    
                    if (isMyPick) {
                        this.state.myTeam.push(player);
                        this.state.myPickCount++;
                    }
                    
                    // Update both tables if they exist
                    this.renderTable();
                    if (document.getElementById('defenseRankingsTable')) {
                        this.renderDefenseTable();
                    }
                    this.updateDraftStatus();
                    this.updateDefenseDraftStatus();
                    this.render(); // Re-render to update archive display
                }
            },

            undraftPlayer(playerId) {
                const archivedPlayerIndex = this.state.archivedPlayers.findIndex(p => p.id == playerId);
                if (archivedPlayerIndex !== -1) {
                    const archivedPlayer = this.state.archivedPlayers[archivedPlayerIndex];
                    
                    // Find the original player and make them available again
                    const player = this.state.players.find(p => p.id == playerId);
                    if (player) {
                        player.isAvailable = true;
                        this.state.draftedPlayers.delete(playerId);
                        
                        // Remove from my team if it was my pick
                        if (archivedPlayer.draftedByUser) {
                            const myTeamIndex = this.state.myTeam.findIndex(p => p.id == playerId);
                            if (myTeamIndex !== -1) {
                                this.state.myTeam.splice(myTeamIndex, 1);
                                this.state.myPickCount--;
                            }
                        }
                        
                        // Remove from archived players
                        this.state.archivedPlayers.splice(archivedPlayerIndex, 1);
                        
                        // Re-render everything
                        this.render();
                    }
                }
            },

            clearArchive() {
                // Restore all archived players as available
                this.state.archivedPlayers.forEach(archivedPlayer => {
                    const player = this.state.players.find(p => p.id == archivedPlayer.id);
                    if (player) {
                        player.isAvailable = true;
                        this.state.draftedPlayers.delete(archivedPlayer.id);
                    }
                });
                
                // Clear everything
                this.state.archivedPlayers = [];
                this.state.myTeam = [];
                this.state.myPickCount = 0;
                
                this.render();
            },

            findPlayerByName(searchName) {
                if (!searchName) return null;
                
                const cleanName = (name) => {
                    return name.toLowerCase()
                        .replace(/[^\w\s]/g, '') // Remove punctuation
                        .replace(/\s+/g, ' ')     // Normalize whitespace
                        .trim();
                };
                
                const cleanSearchName = cleanName(searchName);
                
                // Try exact match first
                let match = this.state.players.find(p => 
                    cleanName(p.name) === cleanSearchName
                );
                
                if (match) return match;
                
                // Try partial match (last name, first name)
                const searchParts = cleanSearchName.split(' ');
                if (searchParts.length >= 2) {
                    const searchLastName = searchParts[searchParts.length - 1];
                    const searchFirstName = searchParts[0];
                    
                    match = this.state.players.find(p => {
                        const playerParts = cleanName(p.name).split(' ');
                        if (playerParts.length >= 2) {
                            const playerLastName = playerParts[playerParts.length - 1];
                            const playerFirstName = playerParts[0];
                            return playerLastName === searchLastName && 
                                   playerFirstName === searchFirstName;
                        }
                        return false;
                    });
                }
                
                if (match) return match;
                
                // Try fuzzy match (contains)
                match = this.state.players.find(p => {
                    const playerName = cleanName(p.name);
                    return playerName.includes(cleanSearchName) || 
                           cleanSearchName.includes(playerName);
                });
                
                return match || null;
            },

            updateDraftStatus() {
                const statusEl = document.getElementById('draft-status');
                if (statusEl) {
                    const totalPicks = this.getTotalPicks();
                    const remaining = totalPicks - this.state.myPickCount;
                    statusEl.textContent = `My Picks: ${this.state.myPickCount}/${totalPicks} | ${remaining} remaining`;
                }
            },

            updateDefenseDraftStatus() {
                const statusEl = document.getElementById('defense-draft-status');
                if (statusEl) {
                    const totalPicks = this.getTotalPicks();
                    const remaining = totalPicks - this.state.myPickCount;
                    statusEl.textContent = `My Picks: ${this.state.myPickCount}/${totalPicks} | ${remaining} remaining`;
                }
            },

            getDashboardView() {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900">Draft Strategy Comparison</h2>
                            <p class="text-slate-600 mb-4">This chart provides a high-level comparison of foundational draft strategies. Each approach carries different risks and rewards, influencing how you should allocate your early-round picks. Hover over the bars for a brief explanation of each strategy's core philosophy.</p>
                            <div class="chart-container">
                                <canvas id="strategyChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900">My Team</h2>
                            <div id="my-team-display" class="space-y-2">
                                ${this.state.myTeam.length === 0 ? 
                                    '<p class="text-slate-500 italic">No players drafted yet</p>' : 
                                    this.state.myTeam.map(p => `
                                        <div class="flex justify-between items-center bg-green-50 p-2 rounded">
                                            <span class="font-semibold">${p.name}</span>
                                            <span class="text-sm bg-green-100 px-2 py-1 rounded">${p.pos}</span>
                                        </div>
                                    `).join('')
                                }
                            </div>
                            ${this.getPositionNeeds()}
                            <div class="mt-4 text-center space-x-2">
                                <button id="clear-team-btn" class="text-sm bg-slate-200 px-3 py-1 rounded hover:bg-slate-300">Clear Team</button>
                                <button id="get-team-advice-btn" class="text-sm bg-amber-500 text-white px-3 py-1 rounded hover:bg-amber-600">Get AI Advice</button>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900">ðŸ“š Drafted Players Archive</h2>
                            <p class="text-slate-600 mb-4">Players that have been drafted. Click 'Undraft' to restore a player if accidentally drafted.</p>
                            <div id="archived-players-display" class="max-h-64 overflow-y-auto">
                                ${this.state.archivedPlayers.length === 0 ? 
                                    '<p class="text-slate-500 italic">No players archived yet</p>' : 
                                    this.state.archivedPlayers.map(p => `
                                        <div class="flex justify-between items-center bg-slate-50 p-2 rounded mb-2 border">
                                            <div class="flex-1">
                                                <span class="font-semibold text-slate-700">${p.name}</span>
                                                <span class="text-sm ml-2 bg-slate-200 px-2 py-1 rounded">${p.pos}</span>
                                                <span class="text-xs text-slate-500 ml-2">${p.team}</span>
                                                ${p.draftedByUser ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2">MY PICK</span>' : '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded ml-2">OTHER</span>'}
                                            </div>
                                            <button data-player-id="${p.id}" class="undraft-btn text-xs bg-amber-500 text-white px-2 py-1 rounded hover:bg-amber-600 transition-colors">
                                                Undraft
                                            </button>
                                        </div>
                                    `).join('')
                                }
                            </div>
                            <div class="mt-4 text-center">
                                <button id="clear-archive-btn" class="text-sm bg-slate-300 px-3 py-1 rounded hover:bg-slate-400" ${this.state.archivedPlayers.length === 0 ? 'disabled' : ''}>
                                    Clear Archive
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900">âœ¨ AI Team Name Generator</h2>
                            <p class="text-slate-600 mb-4">Need some inspiration for a team name? Enter a few keywords (like your favorite player, team, or an inside joke) and let our AI generate some creative options for you!</p>
                            <div class="flex gap-2">
                                <input type="text" id="name-generator-input" placeholder="e.g., 'Bijan, mustard, champion'" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 flex-grow">
                                <button id="name-generator-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-md hover:bg-amber-600 transition-colors">Generate Names</button>
                            </div>
                            <div id="name-generator-results" class="mt-4 p-4 bg-slate-50 rounded-md min-h-[100px]"></div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
                             <h2 class="text-2xl font-bold mb-4 text-slate-900">Foundational Principles</h2>
                             <p class="text-slate-600 mb-4">Success starts with understanding the core concepts of your league. Your specific rules for scoring, rosters (Superflex, IDP), and league size are the most critical factors in determining player value. This dashboard is tailored to a 10-team, Superflex, IDP format with 20 roster spots (13 starters + 7 bench).</p>
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                                <div class="bg-amber-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-amber-800">Superflex is King</h3>
                                    <p class="text-sm text-amber-700">In this format, QBs are the most valuable assets. Securing two reliable starters is paramount.</p>
                                </div>
                                <div class="bg-sky-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-sky-800">Positional Scarcity</h3>
                                    <p class="text-sm text-sky-700">Understand the drop-off in talent at each position. Elite RBs and TEs are rare commodities.</p>
                                </div>
                                 <div class="bg-emerald-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-emerald-800">Tiers Over Ranks</h3>
                                    <p class="text-sm text-emerald-700">Draft from the best available tier, not just the next player on a list. Avoid reaching.</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-purple-800">Bench Strategy</h3>
                                    <p class="text-sm text-purple-700">Your 7 bench spots should cover bye weeks and injuries. Prioritize handcuffs and upside over floor.</p>
                                </div>
                             </div>
                        </div>
                    </div>
                `;
            },
            
            getRankingsView() {
                // Since PPR rank is not in our new data, we remove the selector for it.
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-2">
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900">Player Rankings</h2>
                            <div id="draft-status" class="text-xs md:text-sm font-semibold bg-amber-100 px-2 md:px-3 py-1 rounded text-center">My Picks: 0/${this.getTotalPicks()} | ${this.getTotalPicks()} remaining</div>
                        </div>
                        <p class="text-slate-600 mb-6">Player data loaded from local file. ðŸ“Š=Analyze, âœ“=Draft (others), MY=Draft (your team)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 md:gap-4 mb-4">
                            <input type="text" id="searchInput" placeholder="Search player name..." class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 md:col-span-2 lg:col-span-1">
                            <select id="posFilter" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                ${this.getOffensivePositionFilterOptions()}
                            </select>
                             <select id="statusFilter" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                <option value="ALL">All Players</option>
                                <option value="AVAILABLE">Available Only</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left" id="rankingsTable">
                                </table>
                        </div>
                        <div class="mt-4 text-xs text-slate-500 bg-slate-50 p-2 rounded">
                            <strong>Quick Keys:</strong> Ctrl+1 (Dashboard) â€¢ Ctrl+2 (Rankings) â€¢ Esc (Close Modal)
                        </div>
                    </div>
                `;
            },

            getPositionNeeds() {
                if (this.state.myTeam.length === 0) return '';
                
                const positionCounts = {};
                this.state.myTeam.forEach(p => {
                    positionCounts[p.pos] = (positionCounts[p.pos] || 0) + 1;
                });

                const needs = [];
                const targets = this.state.leagueSettings;
                
                Object.entries(targets).forEach(([pos, target]) => {
                    if (target > 0) {
                        const current = positionCounts[pos] || 0;
                        if (current < target) {
                            needs.push(`${pos}: ${current}/${target}`);
                        }
                    }
                });

                return needs.length > 0 ? `
                    <div class="mt-3 p-2 bg-amber-50 rounded">
                        <p class="text-sm font-semibold text-amber-800">Position Needs:</p>
                        <p class="text-xs text-amber-700">${needs.join(' â€¢ ')}</p>
                    </div>
                ` : '';
            },

            addDashboardEventListeners() {
                document.getElementById('name-generator-btn').addEventListener('click', () => this.generateTeamNames());
                document.getElementById('clear-team-btn')?.addEventListener('click', () => {
                    this.state.myTeam = [];
                    this.state.draftedPlayers.clear();
                    this.state.archivedPlayers = [];
                    this.state.myPickCount = 0;
                    this.state.players.forEach(p => p.isAvailable = true);
                    this.render();
                });
                document.getElementById('get-team-advice-btn')?.addEventListener('click', () => this.getTeamAdvice());
                
                // Archive event listeners
                document.querySelectorAll('.undraft-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playerId = e.target.dataset.playerId;
                        this.undraftPlayer(playerId);
                    });
                });
                
                document.getElementById('clear-archive-btn')?.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear the entire archive? This will restore all players as available.')) {
                        this.clearArchive();
                    }
                });
            },

            async getTeamAdvice() {
                const modal = document.getElementById('ai-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');

                modalTitle.textContent = `ðŸ§  Team Analysis`;
                modalBody.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div><p class="ml-4">Analyzing your team...</p></div>';
                modal.classList.remove('hidden');

                const totalPicks = this.getTotalPicks();
                const myTeamInfo = this.state.myTeam.map(p => `${p.name} (${p.pos}, Bye ${p.bye_week || 'TBD'})`).join(', ');
                
                const prompt = `My current fantasy team: ${myTeamInfo || 'Empty'}. Picks made: ${this.state.myPickCount}/${totalPicks}.

Analyze my team for Superflex/IDP league:
1. **Strengths** (what's working)
2. **Weaknesses** (biggest needs) 
3. **Next 3 Picks** (specific positions/types to target)
4. **Strategy** (what to avoid, what to prioritize)

Keep it under 150 words - I need quick actionable advice!`;
                
                const analysis = await this.callGeminiAPI(prompt);
                modalBody.innerHTML = analysis.replace(/\n/g, '<br>');
            },


            loadSettingsToForm() {
                const settings = this.state.leagueSettings;
                Object.entries(settings).forEach(([pos, value]) => {
                    const input = document.getElementById(`${pos.toLowerCase()}-target`);
                    if (input) input.value = value;
                });
                
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                if (darkModeToggle) darkModeToggle.checked = this.state.darkMode;
            },

            addSettingsEventListeners() {
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.replaceWith(btn.cloneNode(true));
                });
                document.getElementById('save-settings-btn').replaceWith(document.getElementById('save-settings-btn').cloneNode(true));
                document.getElementById('reset-settings-btn').replaceWith(document.getElementById('reset-settings-btn').cloneNode(true));
                document.getElementById('dark-mode-toggle').replaceWith(document.getElementById('dark-mode-toggle').cloneNode(true));

                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const preset = e.currentTarget.dataset.preset;
                        this.loadPreset(preset);
                    });
                });

                document.getElementById('save-settings-btn').addEventListener('click', () => {
                    this.saveSettings();
                });

                document.getElementById('reset-settings-btn').addEventListener('click', () => {
                    this.loadPreset('superflex-idp');
                });

                document.getElementById('dark-mode-toggle').addEventListener('change', (e) => {
                    this.toggleDarkMode();
                });
            },

            loadPreset(presetName) {
                const preset = this.presets[presetName];
                if (preset) {
                    Object.entries(preset).forEach(([pos, value]) => {
                        const input = document.getElementById(`${pos.toLowerCase()}-target`);
                        if (input) input.value = value;
                    });
                    
                    document.querySelectorAll('.preset-btn').forEach(btn => {
                        btn.classList.remove('bg-amber-100', 'border-2', 'border-amber-300');
                        btn.classList.add('bg-slate-100');
                        if (btn.dataset.preset === presetName) {
                            btn.classList.remove('bg-slate-100');
                            btn.classList.add('bg-amber-100', 'border-2', 'border-amber-300');
                        }
                    });
                }
            },

            saveSettings() {
                const newSettings = {};
                ['QB', 'RB', 'WR', 'TE', 'FLEX', 'SF', 'K', 'DST', 'DL', 'LB', 'DB', 'BENCH'].forEach(pos => {
                    const input = document.getElementById(`${pos.toLowerCase()}-target`);
                    newSettings[pos] = parseInt(input.value) || 0;
                });
                
                this.state.leagueSettings = newSettings;
                localStorage.setItem('fantasyLeagueSettings', JSON.stringify(newSettings));
                
                this.state.currentView = 'dashboard';
                this.render();
                this.updateDraftStatus();
                
                this.showNotification('Settings saved successfully!');
            },

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            },

            loadSavedSettings() {
                const saved = localStorage.getItem('fantasyLeagueSettings');
                if (saved) {
                    this.state.leagueSettings = JSON.parse(saved);
                }
                
                const darkMode = localStorage.getItem('fantasyDarkMode');
                if (darkMode) {
                    this.state.darkMode = JSON.parse(darkMode);
                }
            },

            initDarkMode() {
                if (this.state.darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            toggleDarkMode() {
                this.state.darkMode = !this.state.darkMode;
                localStorage.setItem('fantasyDarkMode', JSON.stringify(this.state.darkMode));
                this.initDarkMode();
            },

            getActivePositions() {
                return Object.entries(this.state.leagueSettings)
                    .filter(([pos, count]) => count > 0)
                    .map(([pos]) => pos);
            },

            getPositionFilterOptions() {
                const activePositions = this.getActivePositions();
                
                let options = '<option value="ALL">All Positions</option>';
                
                const positionMap = [
                    { setting: 'QB', display: 'QB' },
                    { setting: 'RB', display: 'RB' },
                    { setting: 'WR', display: 'WR' },
                    { setting: 'TE', display: 'TE' },
                    { setting: 'K', display: 'K' },
                    { setting: 'DST', display: 'DEF' },
                    { setting: 'DL', display: 'DL' },
                    { setting: 'LB', display: 'LB' },
                    { setting: 'DB', display: 'DB' }
                ];
                
                positionMap.forEach(({ setting, display }) => {
                    if (activePositions.includes(setting)) {
                        options += `<option value="${display}">${display}</option>`;
                    }
                });
                
                return options;
            },

            getOffensivePositionFilterOptions() {
                let options = '<option value="ALL">All Positions</option>';
                
                const offensivePositions = [
                    { setting: 'QB', display: 'QB' },
                    { setting: 'RB', display: 'RB' },
                    { setting: 'WR', display: 'WR' },
                    { setting: 'TE', display: 'TE' },
                    { setting: 'K', display: 'K' }
                ];
                
                offensivePositions.forEach(({ setting, display }) => {
                    options += `<option value="${display}">${display}</option>`;
                });
                
                return options;
            },

            addRankingsEventListeners() {
                document.getElementById('searchInput').addEventListener('input', () => this.filterAndRenderTable());
                document.getElementById('posFilter').addEventListener('change', () => this.filterAndRenderTable());
                document.getElementById('statusFilter').addEventListener('change', () => this.filterAndRenderTable());
                this.renderTable();
            },

            addStrategyEventListeners() {
                document.getElementById('get-round-advice-btn').addEventListener('click', () => this.getRoundByRoundAdvice());
            },

            filterAndRenderTable() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const posFilter = document.getElementById('posFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                
                // Only show offensive players in main rankings
                const offensivePositions = ['QB', 'RB', 'WR', 'TE', 'K'];
                
                this.state.filteredPlayers = this.state.players.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(searchTerm);
                    const posMatch = posFilter === 'ALL' || p.pos === posFilter;
                    const statusMatch = statusFilter === 'ALL' || (statusFilter === 'AVAILABLE' && p.isAvailable);
                    const isOffensive = offensivePositions.includes(p.pos);
                    return nameMatch && posMatch && statusMatch && isOffensive;
                });

                // Reset displayed count when filters change
                this.state.displayedPlayerCount = 100;
                this.renderTable();
            },

            renderTable() {
                const table = document.getElementById('rankingsTable');
                if (!table) return;
                
                let sortedPlayers = [...this.state.filteredPlayers];
                sortedPlayers.sort((a,b) => a.display_rank - b.display_rank);
                
                // Only show available players
                const availablePlayers = sortedPlayers.filter(p => p.isAvailable);
                
                this.updateDraftStatus();

                const displayedPlayers = availablePlayers.slice(0, this.state.displayedPlayerCount);
                const hasMorePlayers = availablePlayers.length > this.state.displayedPlayerCount;

                table.innerHTML = `
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="p-3 font-semibold">Rank</th>
                            <th class="p-3 font-semibold">Player</th>
                            <th class="p-3 font-semibold">Position</th>
                            <th class="p-3 font-semibold">Team</th>
                            <th class="p-3 font-semibold">Bye</th>
                            <th class="p-3 font-semibold text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${displayedPlayers.map(p => `
                            <tr class="border-b border-slate-200 hover:bg-slate-50">
                                <td class="p-3 font-bold text-amber-600">${p.display_rank}</td>
                                <td class="p-3 font-semibold">${p.name}</td>
                                <td class="p-3">${p.pos}</td>
                                <td class="p-3">${p.team}</td>
                                <td class="p-3 text-center">${p.bye_week || '-'}</td>
                                <td class="p-3 text-center space-x-1">
                                    <button data-player-id="${p.id}" class="analyze-btn bg-slate-200 text-slate-700 text-xs font-semibold py-1 px-2 rounded hover:bg-amber-200 transition-colors">ðŸ“Š</button>
                                    <button data-player-id="${p.id}" class="draft-btn bg-red-500 text-white text-xs font-semibold py-1 px-2 rounded hover:bg-red-600">âœ—</button>
                                    <button data-player-id="${p.id}" class="my-draft-btn bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded hover:bg-green-600">MY</button>
                                </td>
                            </tr>
                        `).join('')}
                        ${hasMorePlayers ? `
                            <tr class="border-b border-slate-200">
                                <td colspan="6" class="p-4 text-center">
                                    <button id="load-more-btn" class="bg-amber-500 text-white font-semibold py-2 px-4 rounded hover:bg-amber-600 transition-colors">
                                        Load More Players (${availablePlayers.length - this.state.displayedPlayerCount} remaining)
                                    </button>
                                </td>
                            </tr>
                        ` : ''}
                    </tbody>
                `;

                document.querySelectorAll('#rankingsTable .analyze-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playerId = e.target.dataset.playerId;
                        const player = this.state.players.find(p => p.id == playerId);
                        this.showPlayerAnalysis(player);
                    });
                });

                document.querySelectorAll('#rankingsTable .draft-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playerId = e.target.dataset.playerId;
                        this.handleDraft(playerId, false);
                    });
                });

                document.querySelectorAll('#rankingsTable .my-draft-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playerId = e.target.dataset.playerId;
                        this.handleDraft(playerId, true);
                    });
                });

                // Add load more button event listener
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (loadMoreBtn) {
                    loadMoreBtn.addEventListener('click', () => {
                        this.state.displayedPlayerCount += 50;
                        this.renderTable();
                    });
                }
            },

            async callGeminiAPI(prompt, retries = 2) {
                const functionUrl = `/.netlify/functions/gemini`; 
                
                for (let attempt = 0; attempt <= retries; attempt++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);
                        
                        const response = await fetch(functionUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: prompt }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`API failed with status ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                                return "âš ï¸ Content filtered by safety settings. Try a different query.";
                            }
                            throw new Error("No valid response from AI");
                        }
                    } catch (error) {
                        console.warn(`API attempt ${attempt + 1} failed:`, error);
                        if (attempt === retries) {
                            if (error.name === 'AbortError') {
                                return "â±ï¸ Request timed out. Please try again with a simpler query.";
                            }
                            return `âŒ AI analysis unavailable. Error: ${error.message}`;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                    }
                }
            },

            async showPlayerAnalysis(player) {
                const modal = document.getElementById('ai-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');

                modalTitle.textContent = `ðŸŽ¯ ${player.name} (${player.pos})`;
                modalBody.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div><p class="ml-4">Generating analysis...</p></div>';
                modal.classList.remove('hidden');

                const totalPicks = this.getTotalPicks();
                const myTeamPositions = this.state.myTeam.map(p => p.pos).join(', ');
                
                const prompt = `DRAFT SITUATION: ${this.state.myPickCount}/${totalPicks} picks made. My current team: ${myTeamPositions || 'Empty'}.

Provide a CONCISE fantasy analysis for ${player.name} (${player.pos}, ${player.team}, Bye Week ${player.bye_week || 'TBD'}) for 2025 in a 10-team Superflex/IDP league:

1. **Draft Value** (1-2 sentences): Is this player worth drafting NOW (pick ${this.state.myPickCount + 1})?
2. **Key Strengths** (2-3 bullet points)
3. **Concerns** (1-2 bullet points)
4. **2025 Outlook** (2-3 sentences)
5. **RECOMMENDATION**: Draft now, wait X rounds, or avoid? Consider my team needs.

Keep it under 150 words - I need quick decisions during draft!`;
                
                const analysis = await this.callGeminiAPI(prompt);
                modalBody.innerHTML = analysis.replace(/\n/g, '<br>');
            },

            async generateTeamNames() {
                const input = document.getElementById('name-generator-input');
                const resultsContainer = document.getElementById('name-generator-results');
                const keywords = input.value;

                if (!keywords) {
                    resultsContainer.innerHTML = '<p class="text-red-500">Please enter some keywords to generate names.</p>';
                    return;
                }

                resultsContainer.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div><p class="ml-4">Generating names...</p></div>';

                const prompt = `Generate 8 creative fantasy football team names using: "${keywords}". Make them punny, clever, and NFL-related. Format as a simple numbered list.`;

                const namesText = await this.callGeminiAPI(prompt);
                const namesArray = namesText.split('\n').filter(name => name.trim() !== '').slice(0, 8);
                
                resultsContainer.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        ${namesArray.map(name => `<div class="bg-amber-50 p-2 rounded text-sm">${name.replace(/^\d+\.\s*/, '')}</div>`).join('')}
                    </div>
                `;
            },

            async getRoundByRoundAdvice() {
                const roundSelector = document.getElementById('round-selector');
                const resultsContainer = document.getElementById('round-advice-results');
                const selectedRound = roundSelector.value;
                const myTeamPositions = this.state.myTeam.map(p => p.pos).join(', ');

                resultsContainer.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div><p class="ml-4">Generating advice...</p></div>';

                const prompt = `DRAFT CONTEXT: 10-team Superflex/IDP league. My current team: ${myTeamPositions || 'Empty'}.

For ${selectedRound}, provide:
1. **Primary Targets** (positions to prioritize)
2. **Top 3 Players** to target in this range
3. **Strategy** (2-3 sentences)
4. **Avoid** (what NOT to do)

Keep it concise - I need quick actionable advice!`;

                const advice = await this.callGeminiAPI(prompt);
                resultsContainer.innerHTML = advice.replace(/\n/g, '<br>');
            },

            getStrategyView() {
                return `
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-slate-900">Offensive Draft Strategies</h2>
                        <p class="text-slate-600 mt-2 max-w-3xl mx-auto">Your approach in the early rounds will define your team's structure. Below are the three most prominent draft architectures for 2025. Each has a different philosophy on how to handle the critical running back position and build a championship roster. Consider your own risk tolerance and drafting style when choosing your path.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                            <h3 class="text-2xl font-bold text-center mb-4 text-sky-700">Robust RB</h3>
                            <p class="text-slate-600 mb-4 flex-grow">This aggressive strategy involves using your first 2-3 picks on elite, high-volume running backs. The goal is to create an overwhelming advantage at the scarcest position, accepting the injury risk for a massive weekly ceiling.</p>
                            <div class="mt-auto">
                                <p class="font-semibold mb-2">Ideal Targets:</p>
                                <ul class="list-disc list-inside text-slate-700 space-y-1">
                                    <li>Bijan Robinson</li>
                                    <li>Jahmyr Gibbs</li>
                                    <li>Saquon Barkley</li>
                                </ul>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-4 border-amber-400 flex flex-col">
                            <h3 class="text-2xl font-bold text-center mb-4 text-amber-700">Hero RB (Hybrid)</h3>
                            <p class="text-slate-600 mb-4 flex-grow">A popular, balanced approach. You draft one elite "anchor" RB in Round 1 or 2, then pivot to drafting elite WRs, TEs, and QBs for the next several rounds. This gives you a stud RB while still capitalizing on depth at other positions.</p>
                             <div class="mt-auto">
                                <p class="font-semibold mb-2">Ideal Anchor RBs:</p>
                                <ul class="list-disc list-inside text-slate-700 space-y-1">
                                    <li>Bijan Robinson</li>
                                    <li>Jahmyr Gibbs</li>
                                    <li>Christian McCaffrey</li>
                                </ul>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                            <h3 class="text-2xl font-bold text-center mb-4 text-emerald-700">Zero RB</h3>
                            <p class="text-slate-600 mb-4 flex-grow">A contrarian strategy where you avoid RBs entirely for at least the first four rounds. You load up on elite WRs, TEs, and QBs to build a positional advantage, then attack the RB position in the middle rounds, targeting veterans and high-upside backups.</p>
                             <div class="mt-auto">
                                <p class="font-semibold mb-2">Mid-Round Targets:</p>
                                <ul class="list-disc list-inside text-slate-700 space-y-1">
                                    <li>James Conner</li>
                                    <li>Kyren Williams</li>
                                    <li>Chase Brown</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900">âœ¨ AI Round-by-Round Strategy Explorer</h2>
                        <p class="text-slate-600 mb-4">Select a stage of the draft to get targeted, AI-powered advice on who to pick and why, tailored specifically for your league's unique format.</p>
                        <div class="flex gap-2 mb-4">
                            <select id="round-selector" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 flex-grow">
                                <option value="Rounds 1-2">Rounds 1-2</option>
                                <option value="Rounds 3-4">Rounds 3-4</option>
                                <option value="Rounds 5-7">Rounds 5-7 (The Mid-Rounds)</option>
                                <option value="Rounds 8-11">Rounds 8-11 (The Late-Rounds)</option>
                                <option value="Rounds 12+">Rounds 12+ (The Sleepers)</option>
                            </select>
                            <button id="get-round-advice-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-md hover:bg-amber-600 transition-colors">Get Advice</button>
                        </div>
                        <div id="round-advice-results" class="mt-4 p-4 bg-slate-50 rounded-md min-h-[200px]">
                            <p class="text-slate-500">Your AI-generated advice will appear here.</p>
                        </div>
                    </div>
                `;
            },
            
            getIdpView() {
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-2">
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900">Defense Rankings</h2>
                            <div id="defense-draft-status" class="text-xs md:text-sm font-semibold bg-amber-100 px-2 md:px-3 py-1 rounded text-center">My Picks: ${this.state.myPickCount}/${this.getTotalPicks()} | ${this.getTotalPicks() - this.state.myPickCount} remaining</div>
                        </div>
                        <p class="text-slate-600 mb-6">Defensive player rankings for IDP leagues. ðŸ“Š=Analyze, âœ“=Draft (others), MY=Draft (your team)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 md:gap-4 mb-4">
                            <input type="text" id="defenseSearchInput" placeholder="Search player name..." class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 md:col-span-2 lg:col-span-1">
                            <select id="defensePosFilter" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                ${this.getDefensivePositionFilterOptions()}
                            </select>
                             <select id="defenseStatusFilter" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                <option value="ALL">All Players</option>
                                <option value="AVAILABLE">Available Only</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left" id="defenseRankingsTable">
                                </table>
                        </div>
                        <div class="mt-4 text-xs text-slate-500 bg-slate-50 p-2 rounded">
                            <strong>Quick Keys:</strong> Ctrl+1 (Dashboard) â€¢ Ctrl+2 (Rankings) â€¢ Esc (Close Modal)
                        </div>
                    </div>
                `;
            },

            getDefensivePositionFilterOptions() {
                let options = '<option value="ALL">All Positions</option>';
                
                const defensivePositions = [
                    { setting: 'LB', display: 'LB' },
                    { setting: 'DL', display: 'DL' },
                    { setting: 'DB', display: 'DB' },
                    { setting: 'DST', display: 'DST' }
                ];
                
                defensivePositions.forEach(({ setting, display }) => {
                    options += `<option value="${display}">${display}</option>`;
                });
                
                return options;
            },

            filterAndRenderDefenseTable() {
                const searchTerm = document.getElementById('defenseSearchInput').value.toLowerCase();
                const posFilter = document.getElementById('defensePosFilter').value;
                const statusFilter = document.getElementById('defenseStatusFilter').value;
                
                // Only show defensive players
                const defensivePositions = ['LB', 'DL', 'DB', 'DST'];
                
                this.state.defenseFilteredPlayers = this.state.players.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(searchTerm);
                    const posMatch = posFilter === 'ALL' || p.pos === posFilter;
                    const statusMatch = statusFilter === 'ALL' || (statusFilter === 'AVAILABLE' && p.isAvailable);
                    const isDefensive = defensivePositions.includes(p.pos);
                    return nameMatch && posMatch && statusMatch && isDefensive;
                });

                // Reset displayed count when filters change
                if (!this.state.defenseDisplayedPlayerCount) {
                    this.state.defenseDisplayedPlayerCount = 100;
                } else {
                    this.state.defenseDisplayedPlayerCount = 100;
                }
                this.renderDefenseTable();
            },

            renderDefenseTable() {
                const table = document.getElementById('defenseRankingsTable');
                if (!table) return;
                
                if (!this.state.defenseFilteredPlayers) {
                    const defensivePositions = ['LB', 'DL', 'DB', 'DST'];
                    this.state.defenseFilteredPlayers = this.state.players.filter(p => defensivePositions.includes(p.pos));
                }
                
                if (!this.state.defenseDisplayedPlayerCount) {
                    this.state.defenseDisplayedPlayerCount = 100;
                }
                
                let sortedPlayers = [...this.state.defenseFilteredPlayers];
                sortedPlayers.sort((a,b) => a.display_rank - b.display_rank);
                
                // Only show available players
                const availablePlayers = sortedPlayers.filter(p => p.isAvailable);
                
                const displayedPlayers = availablePlayers.slice(0, this.state.defenseDisplayedPlayerCount);
                const hasMorePlayers = availablePlayers.length > this.state.defenseDisplayedPlayerCount;

                table.innerHTML = `
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="p-3 font-semibold">Rank</th>
                            <th class="p-3 font-semibold">Player</th>
                            <th class="p-3 font-semibold">Position</th>
                            <th class="p-3 font-semibold">Team</th>
                            <th class="p-3 font-semibold">Bye</th>
                            <th class="p-3 font-semibold text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${displayedPlayers.map(p => `
                            <tr class="border-b border-slate-200 hover:bg-slate-50">
                                <td class="p-3 font-bold text-amber-600">${p.display_rank}</td>
                                <td class="p-3 font-semibold">${p.name}</td>
                                <td class="p-3">${p.pos}</td>
                                <td class="p-3">${p.team}</td>
                                <td class="p-3 text-center">${p.bye_week || '-'}</td>
                                <td class="p-3 text-center space-x-1">
                                    <button data-player-id="${p.id}" class="analyze-btn bg-slate-200 text-slate-700 text-xs font-semibold py-1 px-2 rounded hover:bg-amber-200 transition-colors">ðŸ“Š</button>
                                    <button data-player-id="${p.id}" class="draft-btn bg-red-500 text-white text-xs font-semibold py-1 px-2 rounded hover:bg-red-600">âœ—</button>
                                    <button data-player-id="${p.id}" class="my-draft-btn bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded hover:bg-green-600">MY</button>
                                </td>
                            </tr>
                        `).join('')}
                        ${hasMorePlayers ? `
                            <tr class="border-b border-slate-200">
                                <td colspan="6" class="p-4 text-center">
                                    <button id="defense-load-more-btn" class="bg-amber-500 text-white font-semibold py-2 px-4 rounded hover:bg-amber-600 transition-colors">
                                        Load More Players (${availablePlayers.length - this.state.defenseDisplayedPlayerCount} remaining)
                                    </button>
                                </td>
                            </tr>
                        ` : ''}
                    </tbody>
                `;

                // Add event listeners for defense table only
                document.querySelectorAll('#defenseRankingsTable .analyze-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playerId = e.target.dataset.playerId;
                        const player = this.state.players.find(p => p.id == playerId);
                        this.showPlayerAnalysis(player);
                    });
                });

                document.querySelectorAll('#defenseRankingsTable .draft-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playerId = e.target.dataset.playerId;
                        this.handleDraft(playerId, false);
                    });
                });

                document.querySelectorAll('#defenseRankingsTable .my-draft-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playerId = e.target.dataset.playerId;
                        this.handleDraft(playerId, true);
                    });
                });

                // Add defense load more button event listener
                const defenseLoadMoreBtn = document.getElementById('defense-load-more-btn');
                if (defenseLoadMoreBtn) {
                    defenseLoadMoreBtn.addEventListener('click', () => {
                        this.state.defenseDisplayedPlayerCount += 50;
                        this.renderDefenseTable();
                    });
                }
            },

            addDefenseEventListeners() {
                const searchInput = document.getElementById('defenseSearchInput');
                const posFilter = document.getElementById('defensePosFilter');
                const statusFilter = document.getElementById('defenseStatusFilter');
                
                if (searchInput) searchInput.addEventListener('input', () => this.filterAndRenderDefenseTable());
                if (posFilter) posFilter.addEventListener('change', () => this.filterAndRenderDefenseTable());
                if (statusFilter) statusFilter.addEventListener('change', () => this.filterAndRenderDefenseTable());
                
                this.renderDefenseTable();
            },

            getSettingsView() {
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-bold mb-6 text-slate-900">âš™ï¸ League Settings</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-lg font-semibold mb-4 text-slate-800">League Format Presets</h3>
                                <div class="space-y-3">
                                    <button class="preset-btn w-full text-left p-4 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors" data-preset="standard">
                                        <div class="font-semibold">Standard (15 players)</div>
                                        <div class="text-sm text-slate-600 mt-1">Starters: QB(1), RB(2), WR(2), TE(1), Flex(1), K(1), DST(1) + 7 Bench</div>
                                    </button>
                                    <button class="preset-btn w-full text-left p-4 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors" data-preset="superflex">
                                        <div class="font-semibold">Superflex (16 players)</div>
                                        <div class="text-sm text-slate-600 mt-1">Starters: QB(1), RB(2), WR(2), TE(1), Flex(1), SF(1), K(1), DST(1) + 7 Bench</div>
                                    </button>
                                    <button class="preset-btn w-full text-left p-4 bg-amber-100 rounded-lg hover:bg-amber-200 border-2 border-amber-300 transition-colors" data-preset="superflex-idp">
                                        <div class="font-semibold">Superflex + IDP (20 players)</div>
                                        <div class="text-sm text-slate-600 mt-1">Starters: QB(1), RB(1), WR(2), TE(1), Flex(4), SF(1), DL(1), LB(1), DB(1) + 7 Bench = 20 Total</div>
                                    </button>
                                    <button class="preset-btn w-full text-left p-4 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors" data-preset="deep-idp">
                                        <div class="font-semibold">Deep IDP (18-player)</div>
                                        <div class="text-sm text-slate-600 mt-1">QB(2), RB(4), WR(5), TE(2), DL(2), LB(4), DB(3)</div>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-4 text-slate-800">Custom Roster Targets</h3>
                                <p class="text-sm text-slate-600 mb-4 italic">Note: These numbers include starters + bench for each position</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Quarterbacks</label>
                                        <input type="number" id="qb-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="5" value="2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Running Backs</label>
                                        <input type="number" id="rb-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="8" value="3">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Wide Receivers</label>
                                        <input type="number" id="wr-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="8" value="4">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Tight Ends</label>
                                        <input type="number" id="te-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="4" value="2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Flex (RB/WR/TE)</label>
                                        <input type="number" id="flex-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="3" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Superflex (QB/RB/WR/TE)</label>
                                        <input type="number" id="sf-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="2" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Kickers</label>
                                        <input type="number" id="k-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="2" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Defense/ST</label>
                                        <input type="number" id="dst-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="2" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Defensive Line</label>
                                        <input type="number" id="dl-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="5" value="2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Linebackers</label>
                                        <input type="number" id="lb-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="6" value="3">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Defensive Backs</label>
                                        <input type="number" id="db-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="5" value="2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Bench</label>
                                        <input type="number" id="bench-target" class="w-full p-2 border border-slate-300 rounded" min="0" max="10" value="7">
                                    </div>
                                </div>
                                <div class="mt-6 flex flex-wrap gap-3">
                                    <button id="save-settings-btn" class="bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 transition-colors">Save Settings</button>
                                    <button id="reset-settings-btn" class="bg-slate-300 text-slate-700 px-6 py-2 rounded-lg hover:bg-slate-400 transition-colors">Reset</button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t border-slate-300">
                            <h3 class="text-lg font-semibold mb-4 text-slate-800">Appearance</h3>
                            <div class="flex items-center justify-between max-w-xs">
                                <span class="text-slate-700 font-medium">Dark Mode</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderCharts() {
                Object.values(this.state.charts).forEach(chart => chart.destroy());
                
                if (this.state.currentView === 'dashboard') {
                    this.renderStrategyChart();
                }
            },

            renderStrategyChart() {
                const ctx = document.getElementById('strategyChart')?.getContext('2d');
                if (!ctx) return;

                const data = {
                    labels: ['Robust RB', 'Hero RB', 'Zero RB'],
                    datasets: [{
                        label: 'Risk Level',
                        data: [9, 6, 7],
                        backgroundColor: ['rgba(56, 189, 248, 0.6)', 'rgba(251, 191, 36, 0.6)', 'rgba(16, 185, 129, 0.6)'],
                        borderColor: ['#0284c7', '#d97706', '#059669'],
                        borderWidth: 2,
                    }, {
                        label: 'Upside Potential',
                        data: [8, 9, 10],
                        backgroundColor: ['rgba(56, 189, 248, 0.3)', 'rgba(251, 191, 36, 0.3)', 'rgba(16, 185, 129, 0.3)'],
                        borderColor: ['#0284c7', '#d97706', '#059669'],
                        borderWidth: 2,
                    }]
                };

                this.state.charts.strategyChart = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                grid: { color: '#e2e8f0' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    footer: (tooltipItems) => {
                                        const strategy = tooltipItems[0].label;
                                        const descriptions = {
                                            'Robust RB': 'Prioritizes RBs early to build an advantage at a scarce position.',
                                            'Hero RB': 'Secures one elite RB, then focuses on other positions.',
                                            'Zero RB': 'Fades RBs early to load up on elite WRs/TEs/QBs.'
                                        };
                                        return descriptions[strategy] || '';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());

        // Extension communication handler
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
                if (message.action === 'draft_pick') {
                    console.log('Received draft pick from extension:', message.player);
                    
                    // Find matching player and draft them
                    const matchedPlayer = App.findPlayerByName(message.player.name);
                    if (matchedPlayer) {
                        console.log('Found matching player:', matchedPlayer);
                        App.handleDraft(matchedPlayer.id, message.player.isMyPick);
                        sendResponse({status: 'success', player: matchedPlayer.name});
                    } else {
                        console.log('Player not found in database:', message.player.name);
                        sendResponse({status: 'not_found', searchedName: message.player.name});
                    }
                } else if (message.action === 'test_connection') {
                    console.log('Extension test connection received');
                    sendResponse({status: 'connected', timestamp: new Date().toISOString()});
                }
            });
        }
    </script>
</body>
</html>
